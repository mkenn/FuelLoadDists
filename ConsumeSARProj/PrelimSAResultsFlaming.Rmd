---
title: "Preliminary Consume/FOFEM sensitivity analysis results for flaming fuels"
author: "Maureen Kennedy"
date: "June 4, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r getdata, echo=FALSE,include=FALSE}
# here are results from a first go at the sensitivity analysis
# with the penulimate version of the database
# For flaming fuels, generated by GlobalSACleanConsFOFEMWithPRCCForPub.R
load("SAResults/PrelimFlamingConsFOFEM.RData")
```

## Overview of methods

For the senstivity analysis we will take a representative evt group from the list generated for the database manuscript. We also chose fuel types that typify flaming v. smoldering consumption below. In this first example we chose EVT group number 682 because it has decent representation of the chosen flaming fuel types (1-hr, 10-hr, 100-hr, herb, litter, and shrub).

We then calculate the empirical rank correlation matrix for those fuel types, in that EVT group as estimated by the database. Here is an example matrix for the chosen flaming fuels in EVT group 682. Note that this is a symmtric matrix, with the diagonal having values of 1. So we see a positive rank correlation of 0.53 between 10 and 100-hr loading 

```{r exampleEmpCorr,echo=FALSE}
tmpcor<-round(sens.mats.flame.list$corr.mats[[cur.evt]],digits=3)
colnames(tmpcor)<-c("100hr","10hr","1hr","herb","litter","shrub")
rownames(tmpcor)<-c("100hr","10hr","1hr","herb","litter","shrub")
knitr::kable(tmpcor)
```

We then take a random sample from the marginal hurdle distribution estimated from the database, independently for each fuel type. A matrix calculation is performed that rearranges the columns of this random sample in a way that approximates the empirical rank correlation structure above, while retaining the individual marginal distributions. Note that this doesn't require estimating a joint distribution for the fuel loading types. Here is the correlation structure for the random sample (N = 5000 for each fuel type)

```{r exampleSampleCorr,echo=FALSE}
tmp2cor<-round(cor(sens.mats.flame.list$sens.sort[[cur.evt]]),digits=3)
colnames(tmp2cor)<-c("100hr","10hr","1hr","herb","litter","shrub")
rownames(tmp2cor)<-c("100hr","10hr","1hr","herb","litter","shrub")
knitr::kable(tmp2cor)
```

We see that the sampled correlation structure is similar to the empirical correlation structure, although there is a slight bias to underrepresenting the *magnitude* of the correlation, as can be seen with a plot of the absolute values of the rank correlations. 

```{r comCors,echo=FALSE,fig.height=3.5,fig.width=4}
tmpVec<-sens.mats.flame.list$corr.mats[[cur.evt]][upper.tri(sens.mats.flame.list$corr.mats[[cur.evt]])]

tmp2Vec<-cor(sens.mats.flame.list$sens.sort[[cur.evt]])[upper.tri(cor(sens.mats.flame.list$sens.sort[[cur.evt]]))]

par(mar=c(3.5,3.5,0.5,0.5),mgp=c(2.5,0.5,0),las=1)
plot(abs(tmpVec),abs(tmp2Vec),pch=16,xlab="|Empirical rank correlation|",ylab="|Sampled rank correlation|")
abline(0,1,lwd=2)
```

We tested two sensitivity metrics. The first is the Sobol variance partitioning procedure, which partitions the total variability in a given model output to the contribution of each variable in the sensitivity analysis. A total sensitivity index is used to rank the input variables, with a higher value indicating that the model output is more sensitive to that input variable. This procedure requires rearranging the sample data matrix, which further (slightly) dampens the magnitude of the sampled correlations, although they are still positively related (correlation of the magnitude of the rank correlations is 0.99). See below.

```{r exampleSobolCorr, echo=FALSE,fig.height=3.5,fig.width=4}
tmpVec<-sens.mats.flame.list$corr.mats[[cur.evt]][upper.tri(sens.mats.flame.list$corr.mats[[cur.evt]])]

tmp2Vec<-cor(corr.sampF.vals)[upper.tri(cor(corr.sampF.vals))]

par(mar=c(3.5,3.5,0.5,0.5),mgp=c(2.5,0.5,0),las=1)
plot(abs(tmpVec),abs(tmp2Vec),pch=16,xlab="|Empirical rank correlation|",ylab="|Sampled Sobol rank correlation|")
abline(0,1,lwd=2)

```

We also calculated partial rank correlation coefficiens (prcc). This estimates the correlation between each model output and each sampled input variable, accounting for any relationships among the remaining variables (with each other, and with the model outputs). This calculation is performed on the sampled variable matrix (before the Sobol rearrangement). 

For each sensitivity metric we performed 1000 bootstrap resampling to estimate bootstrap standard deviations. 

For each EVT we identified a representative fuelbed, which is used to fill in baseline values for the remaining fuel types. Note then that this is a limited global SA, such that a subset of all input variables are sampled, with the rest remaining at the baseline value. For this EVT we identified fuelbed 110 from the FCCS database as the baseline fuelbed. We also chose baseline environmental settings for each model. For future SA we might consider interactions between fuel loadings and environmental variables.

```{r envBase,echo=FALSE}
env.in<-read.csv("sample_consume_input.csv")
knitr::kable(env.in[1,])

```

\newpage
## Sobol

Here are the results for the Sobol variance partitioning. For Consume we see that litter is identified with the highest sensitivity index, with 100-hr loading the second highest. The others have indices near zero.

```{r plotConsSobol,echo=FALSE,fig.height=10,fig.width=10}
par(mfrow=c(2,2),mar=c(12,3,2.5,0.5),mgp=c(2,0.5,0),las=1)
for(k in 1:length(response.vars))
  my.plot.sobol(n.var = nrow(sens.list[[k]]$S),sobol.obj = sens.list[[k]],
                main.txt=paste("EVT:",evt.vals[cur.evt],"Consume\n","output:",response.vars[k]))

```

\pagebreak
Note that FOFEM separates flaming and smoldering for each emissions type. First we look at flaming emissions for the flaming fuel types. For FOFEM we see that litter is identified with the highest sensitivity index, with the remaining inputs with indices near zero.

```{r plotFOFEMSobol,echo=FALSE,fig.height=10,fig.width=10}
par(mfrow=c(2,2),mar=c(12,3,2.5,0.5),mgp=c(2,0.5,0),las=1)
for(k in 1:length(responseF.vars))
    my.plot.sobol(n.var = 6,sobol.obj = sens.fofem.list[[k]],
                  main.txt=paste("EVT:",evt.vals[cur.evt],"FOFEM","output:",responseF.vars[k]))

```

\pagebreak
For the smoldering output (with flaming fuel types), different fuel types appear as the most influential for FOFEM, particularly the largest flaming (100-hr) fuels, with litter not influential.
```{r plotFOFEMSobol2,echo=FALSE,fig.height=10,fig.width=10}
par(mfrow=c(2,2),mar=c(12,3,2.5,0.5),mgp=c(2,0.5,0),las=1)
for(k in 1:length(responseS.vars))
    my.plot.sobol(n.var = 6,sobol.obj = sens.fofemS.list[[k]],
                  main.txt=paste("EVT:",evt.vals[cur.evt],"FOFEM","output:",responseS.vars[k]))

```

\pagebreak

## prcc

Now the partial rank correlation coefficients, presented in the same order as the Sobol above.

**Consume**, we see that more inputs pop out as influential, although the rankings are consistent, with first litter and then 100-hr fuels.

```{r plotConsprcc,echo=FALSE,fig.height=10,fig.width=10}
par(mfrow=c(2,2),mar=c(12,3,1.5,0.5),mgp=c(2,0.5,0),las=1)
for(k in 1:length(response.vars))
  my.plot.prcc(n.var=length(flaming3.id),prcc.obj = consumeF.prcc[[k]],
               main.txt=paste("EVT:",evt.vals[cur.evt],"Consume","output:",response.vars[k]))

```

\pagebreak
We see something similar with **FOFEM** (flaming input and output), where more variables seem to be influential, although the rankings are similar. Litter again is seen as the most influential, and now hern and shrub are shown as influential in rankings similar to the Consume prcc. As with Sobol, 100-hr is still not seen as influential for the flaming FOFEM output. 

```{r plotFOFEMprcc,echo=FALSE,fig.height=10,fig.width=10}
par(mfrow=c(2,2),mar=c(12,3,1.5,0.5),mgp=c(2,0.5,0),las=1)
for(k in 1:length(responseF.vars))
  my.plot.prcc(n.var=6,prcc.obj = fofemF.prcc[[k]],
               main.txt=paste("EVT:",evt.vals[cur.evt],"FOFEM","output:",responseF.vars[k]))

```

\pagebreak
For the FOFEM smoldering output (flaming inputs) prcc ranks 100-hr as most influential, followed by 10-hr. This is consisent with the Sobol smoldering output rankings for FOFEM.

```{r plotFOFEM2prcc,echo=FALSE,fig.height=10,fig.width=10}
par(mfrow=c(2,2),mar=c(12,3,1.5,0.5),mgp=c(2,0.5,0),las=1)
for(k in 1:length(responseS.vars))
  my.plot.prcc(n.var=6,prcc.obj = fofemS.prcc[[k]],
                 main.txt=paste("EVT:",evt.vals[cur.evt],"FOFEM","output:",responseS.vars[k]))

```

\pagebreak

##Ignoring correlation structure

We repeated the same analyses on the sampled data before the matrix manipulation to approximate the correlation structure, such that the sampled input variables are uncorrelated. The results did not change between correlated and uncorrelated inputs.

Here I show results for all analysis with uncorrelated inputs, for PM2.5 only.

```{r unCorrGraph,echo=FALSE,fig.height=10,fig.width=12}
k<-4
par(mfrow=c(2,3),mar=c(12,3,1.5,0.5),mgp=c(2,0.5,0),las=1)
  my.plot.sobol(n.var = nrow(sensNoCorr.list[[k]]$S),sobol.obj = sensNoCorr.list[[k]],
                main.txt=paste("EVT:",evt.vals[cur.evt],"Consume","output:",response.vars[k]))
  my.plot.prcc(n.var=length(flaming3.id),prcc.obj = consumeFNoCorr.prcc[[k]],
               main.txt=paste("EVT:",evt.vals[cur.evt],"Consume No Corr","output:",response.vars[k]))

    k<-3
    my.plot.sobol(n.var = 6,sobol.obj = sens.fofemNoCorr.list[[k]],
                  main.txt=paste("EVT:",evt.vals[cur.evt],"FOFEM NoCorr","output:",responseF.vars[k]))
  my.plot.prcc(n.var=6,prcc.obj = fofemNoCorrF.prcc[[k]],
               main.txt=paste("EVT:",evt.vals[cur.evt],"FOFEMNoCorr","output:",responseF.vars[k]))
    my.plot.sobol(n.var = 6,sobol.obj = sens.fofemNoCorrS.list[[k]],
                  main.txt=paste("EVT:",evt.vals[cur.evt],"FOFEM","output:",responseS.vars[k]))

  my.plot.prcc(n.var=6,prcc.obj = fofemNoCorrS.prcc[[k]],
               main.txt=paste("EVT:",evt.vals[cur.evt],"FOFEMNoCorr","output:",responseF.vars[k]))

```

\newpage

##Uncertainty intervals

The similarity in results for SA with and without correlation implies that for the purposes of SA, we can ignore the correlation structure. However, the matrix manipulation will be useful when producing ensemble maps from random combinations of loading values. For example, here is a histogram of estimated PM2.5 emissions for this EVT, based on the correlated random sample. Vertical lines are drawn at the middle 95% of these values, defining a 95% uncertainty interval for PM2.5 emissions for this EVT (and dashed lines at 90%).

```{r exampleUncertaintyHist,echo=FALSE,fig.height=3.5,fig.width=4}
par(mfrow=c(1,1),mar=c(3.5,3.5,2.5,0.5),mgp=c(2,0.5,0),las=1)
hist(consume2.prcc.sa.results[,response.vars[4]],
     xlab="PM 2.5 (tons/acre)",main=paste("EVT:",evt.vals[cur.evt],"Consume\n","output:",response.vars[4]))
q.vals<-quantile(consume2.prcc.sa.results[,response.vars[4]],probs = c(0.025,0.975))
abline(v=q.vals,lwd=2)
q2.vals<-quantile(consume2.prcc.sa.results[,response.vars[4]],probs = c(0.05,0.95))
abline(v=q2.vals,lwd=2,lty=2)

```

There are some interesting discussion points regarding explanation of seemingly different results for Consume and FOFEM, particularly in distinguishing smoldering from flaming. 

Note also that Consume gives results in tons/acre and FOFEM lbs/acre (I think; so these are mass/area; 1 ton = 2000 lbs). Would be nice to be able to compare these to air quality standards (which seem to be mass/volume). Need to clarify the consume outputs--not sure if I've been looking at tons or tons/acre. Also, Consume shows a baseline area of 100 acres--does this matter for the totals? I don't see an area specified for FOFEM predictions. The issue I'm seeing is that the units for the emissions don't translate--they don't seem to be 3 orders of magnitude different (1:2000). 

Next steps: Update with final database empirical fits. Find example EVT group with representation in the smoldering fuel types, and repeat above analyses. I also just found consume by combustion phase (S v. F v. R). Can compare those results and see if we get a similar pattern with 100-hr fuels

```{r consumeByPhase,echo=FALSE,fig.height=10,fig.width=12}
library(sensitivity)
responseFConsume.vars<-c("E_co_F","E_co2_F","E_pm25_F")
responseSConsume.vars<-c("E_co_S","E_co2_S","E_pm25_S")

sensFConsume.list<-list()
sensSConsume.list<-list()
par(mfrow=c(2,3),mar=c(12,3,1.5,0.5),mgp=c(2,0.5,0),las=1)
for(k in 1:length(responseFConsume.vars))
{ # here we standardize outputs to the z-score
  # sens.list[[k]]<-tell(sobolF,
  #                      (results.sa[,response.vars[k]]-mean(results.sa[,response.vars[k]]))/sd(results.sa[,response.vars[k]]))
  sensFConsume.list[[k]]<-tell(sobolF,consume.sobol.sa.results[,responseFConsume.vars[k]]) # for non-centered
  
    
  rownames(sensFConsume.list[[k]]$S)<-names(corr.sampF.vals)
  my.plot.sobol(n.var = nrow(sensFConsume.list[[k]]$S),sobol.obj = sensFConsume.list[[k]],
                main.txt=paste("EVT:",evt.vals[cur.evt],"Consume","output:",responseFConsume.vars[k]))
  sensSConsume.list[[k]]<-tell(sobolF,consume.sobol.sa.results[,responseSConsume.vars[k]]) # for non-centered
  
    
  rownames(sensSConsume.list[[k]]$S)<-names(corr.sampF.vals)
  my.plot.sobol(n.var = nrow(sensSConsume.list[[k]]$S),sobol.obj = sensSConsume.list[[k]],
                main.txt=paste("EVT:",evt.vals[cur.evt],"Consume","output:",responseSConsume.vars[k]))
}


```

An interesting difference between Consume and FOFEM in the results that are labeled flaming v. smoldering. Here are plots of the flaming v. smoldering CO values for each. Consume shows that in general the flaming is a nearly fixed proportion of the smoldering. FOFEM clearly has a more complex calculation. 

```{r flameVSmold, echo=FALSE,fig.height=3.5,fig.width=8}
par(mfrow=c(1,2),mar=c(3.5,3.5,1.5,0.5),mgp=c(2.25,0.5,0),las=1)
plot(consume.sobol.sa.results[,responseFConsume.vars[1]],
     consume.sobol.sa.results[,responseSConsume.vars[1]],xlab="Flaming CO",ylab="Smoldering CO",
     main="Consume")
plot(results.fofem.sa[,responseF.vars[1]],results.fofem.sa[,responseS.vars[1]],
     xlab="Flaming CO",ylab="Smoldering CO",
     main="FOFEM")
```
